<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panda Pixel</title>
    <link data-trunk rel="css" href="public/app.css"/>
    <link data-trunk rel="copy-dir" href="../assets"/>
</head>
<body>
    <div id="root"></div>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            // Minimal startup logging
            if (window.__TAURI__) {
                console.log('üöÄ Panda Pixel starting (Tauri mode)');
            } else {
                console.log('üöÄ Panda Pixel starting (browser mode)');
            }

            // Keyboard shortcut to open devtools (F12 or Ctrl+Shift+I)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                    if (window.__TAURI__) {
                        const invoke = window.__TAURI__.core?.invoke ||
                                      window.__TAURI__.tauri?.invoke ||
                                      window.__TAURI__.invoke;
                        if (invoke) {
                            invoke('open_devtools').catch(err => {
                                console.error('Failed to open devtools:', err);
                                console.log('üí° Tip: Devtools should open automatically in debug mode');
                            });
                        }
                    } else {
                        console.log('üí° Tauri API not available - running in browser mode');
                    }
                }
            });

            // Set up ResizeObserver for window auto-resize
            const container = document.querySelector('.container');
            if (container) {
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const rect = entry.contentRect;
                        const width = rect.width;
                        const height = rect.height;

                        // Silent resize logging

                        // Call Tauri command if available
                        if (window.__TAURI__) {
                            const invoke = window.__TAURI__.core?.invoke ||
                                          window.__TAURI__.tauri?.invoke ||
                                          window.__TAURI__.invoke;
                            if (invoke) {
                                invoke('resize_window', {
                                    width: width,
                                    height: height
                                }).catch(err => console.error('Resize error:', err));
                            }
                        }
                    }
                });

                resizeObserver.observe(container);
            }

            // Set up Tauri native drag & drop events
            if (window.__TAURI__) {
                const eventApi = window.__TAURI__.event || window.__TAURI__.core?.event;
                if (eventApi?.listen) {
                    // Drag & drop listeners set up silently

                    // Listen for drag-drop event (files dropped on window)
                    eventApi.listen('tauri://drag-drop', (event) => {
                        if (event.payload?.paths && Array.isArray(event.payload.paths)) {
                            const filePaths = event.payload.paths;
                            const sample = filePaths.slice(0, 3).map(p => {
                                const parts = p.split(/[/\\]/);
                                return parts[parts.length - 1] || p;
                            });
                            console.log(`üì¶ drag-drop: ${filePaths.length} files (sample: ${sample.join(', ')})`);

                            // Call Tauri command to process dropped files
                            const invoke = window.__TAURI__.core?.invoke ||
                                          window.__TAURI__.tauri?.invoke ||
                                          window.__TAURI__.invoke;
                            if (invoke) {
                                invoke('handle_dropped_files', { filePaths: filePaths })
                                    .then((files) => {
                                        console.log(`‚úÖ Processed ${files.length} dropped files`);
                                        window.dispatchEvent(new CustomEvent('files-dropped', {
                                            detail: { files: files }
                                        }));
                                    })
                                    .catch(err => {
                                        console.error('‚ùå Failed to process dropped files:', err);
                                    });
                            }
                        }
                    }).catch(() => {});

                    // Only log drag-enter (not drag-over spam)
                    let dragEnterCount = 0;
                    eventApi.listen('tauri://drag-enter', (e) => {
                        const paths = e.payload?.paths || [];
                        const sample = paths.slice(0, 3).map(p => {
                            const parts = p.split(/[/\\]/);
                            return parts[parts.length - 1] || p;
                        });
                        console.log(`üì• drag-enter: ${paths.length} files (sample: ${sample.join(', ')})`);
                    }).catch(() => {});
                } else {
                    console.log('‚ö†Ô∏è Tauri event API not available');
                }
            }
        });
    </script>
</body>
</html>
