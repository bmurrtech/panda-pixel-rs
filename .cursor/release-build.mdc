---
alwaysApply: false
---
# Release Workflow Rule (Local Gate → Tagged CI Release)

This repo uses a **local-first release gate**:

1. **LOCAL RELEASE REHEARSAL (required):** you must be able to build locally before tagging.
2. **CI RELEASE (tag-triggered):** GitHub Actions builds and publishes cross-platform artifacts when a version tag is pushed.

This approach intentionally avoids running CI validation on every push/PR. CI exists primarily to produce publishable installers across macOS/Windows/Linux.

---

## Local Release Rehearsal (Required Before Tagging)

**Purpose:** if `cargo tauri build` fails locally, CI will almost certainly fail too (just slower). Fix locally first.

### Local prerequisites (developer machine)

- Rust installed and up to date (match pinned toolchain where possible).
- WASM target installed:
  - `rustup target add wasm32-unknown-unknown`
- Frontend build tooling installed (as required by the repo; typically `trunk`).
- Platform-native deps installed:
  - Linux requires Tauri GTK/WebKit deps and `nasm` if AVIF/rav1e is enabled.

### Required local commands (clean rehearsal)

From repo root:

```bash
cargo clean
rustup target add wasm32-unknown-unknown
./build-frontend.sh   # or ./build-frontend.ps1 on Windows
cd src-tauri
cargo tauri build
```

**Pass criteria:** build completes successfully and produces bundles (location may vary by workspace):

- `target/release/bundle/` OR
- `src-tauri/target/release/bundle/`

---

### Pinning Policy (Best Practice + Lifecycle)

#### What we pin and why

Release CI pins for reproducible builds:

- **Rust toolchain** (e.g., 1.89.0)
- **Build tools** (e.g., trunk, tauri-cli)
- **Actions versions** (at least major tags; optionally SHA-pin for stronger supply-chain integrity)

Pinning prevents “surprise breakage” from upstream tool updates during a release build.

#### Pinning is not “set and forget”

Pins must be reviewed and refreshed on a defined cadence, and the process must ensure supply-chain security and reproducibility.

##### **Update cadence and rule**

- **Every time you prepare a release:**  
  - **You MUST run `cargo audit` for your local gate/rehearsal build, prior to CI and tagging.**  
  - **You MUST update the `release.yml` workflow in `.github/workflows` with the latest compatible versions for all pinned tools (Rust, trunk, tauri-cli, etc.), unless a valid blocker prevents update.**

- **Additionally:**
  - **Review and bump pins if either:**
    - A security advisory affects pinned tooling, or
    - You need a platform/build fix for shipping.

##### **Upgrade procedure (safe and repeatable)**

1. Update pinned versions (Rust, trunk, tauri-cli, etc.) in `.github/workflows/release.yml`.
2. Run the local gate rehearsal:
    - `cargo clean && ./build-frontend.sh && cd src-tauri && cargo tauri build`
3. Run `cargo audit` and resolve any reported vulnerabilities before proceeding.
4. Cut a pre-release tag (e.g., `-rc.1` or `-alpha`) to validate CI across the OS matrix.
5. Promote to a stable tag once CI is green and all audits pass.

##### **When not to pin**

- Avoid floating versions in release CI. Floating versions are OK **only** for:
  - Exploratory or dev-only scripts.
  - Non-release workflows that can tolerate breakage (this repo intentionally avoids those).

---

## CI Release (Tag-Triggered)

**Trigger:** pushing a git tag matching `v*` (example: `v0.1.0-alpha`, `v1.2.3`).

**Purpose:** produce distributable artifacts for the OS matrix and publish them to GitHub Releases.

### Optimization + reproducibility policy

- Pin Rust toolchain and cache Rust builds.
- Pin and cache CLI tools (e.g., trunk, tauri-cli) for deterministic installs.
- Apply ship-grade build knobs in CI only (do not bake them into Cargo.toml):
  - ThinLTO recommended for published artifacts.
  - `codegen-units=1` only if measured beneficial.

### Cargo.toml policy

Keep `[profile.release]` fast by default. Do **NOT** enable LTO or `codegen-units=1` by default in `Cargo.toml`.

**Recommended baseline:**

```toml
[profile.release]
opt-level = 3
strip = true
panic = "abort"
# Keep these OFF by default; apply via CI for tagged builds:
# lto = "thin"
# codegen-units = 1
```

---

## Tagging and Release Commands (Canonical)

### 1) Prepare release notes (annotated tag message)

Create a temporary tag message file. Use **ONLY** the sections that apply; omit any section that is empty / N/A.

**Example:**

```bash
cd /Users/bmurrtech/Documents/Code/rust-tinypng-clone && cat > /tmp/tag_message.txt << 'EOF'
vX.Y.Z[-label]

## Highlights
- <one-liner describing the most important outcome>
- <second key outcome>

## What's new
- <new feature 1>
- <new feature 2>

## Improvements
- <performance/ux/reliability improvements>

## Breaking changes / required actions
- <what users must do differently, if anything>

## Known issues
- <known issue 1>
- <known issue 2>

## Install notes
- <signing/notarization expectations, OS warnings, special instructions>
EOF

cat /tmp/tag_message.txt
```

**Section rubric (omit if N/A):**

- **Highlights:** 2–4 bullets; highest-impact user-facing changes.
- **What's new:** feature additions and new capabilities.
- **Improvements:** performance, stability, UX polish, build/CI reliability.
- **Breaking changes / required actions:** explicit user actions, config changes, removed behavior.
- **Known issues:** only include real known issues; otherwise omit.
- **Install notes:** signing/notarization status, expected OS warnings, installer formats, special steps.

### 2) Create an annotated tag (uses the release notes)

```bash
git status
git pull --rebase

# Create annotated tag with the message file
git tag -a vX.Y.Z[-label] -F /tmp/tag_message.txt

# Verify locally
git show vX.Y.Z[-label]
```

### 3) Push the tag to trigger the CI release

```bash
git push origin vX.Y.Z[-label]
```

This tag push triggers the release workflow, which builds artifacts and uploads them to the GitHub Release for that tag.

---

## Versioning Guidance

- Use `vMAJOR.MINOR.PATCH` for stable releases (e.g., `v1.2.3`).
- Use `-alpha`, `-beta`, `-rc.N` for pre-releases (e.g., `v0.1.0-alpha`, `v1.0.0-rc.1`).
- Prefer monotonic tags (do not re-use or move tags).

---

## Release Notes Quality Bar

Release notes should be:

- **User-centered:** describe outcomes, not internal refactors (unless it affects users).
- **Scannable:** short bullets, no wall-of-text.
- **Honest:** include breaking changes and known issues when applicable.
- **Safe:** call out unsigned build warnings clearly when relevant.
