name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2

      - name: Install WASM target
        run: rustup target add wasm32-unknown-unknown

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            nasm

      - name: Install Trunk
        run: cargo install trunk --locked

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Build frontend (Unix)
        if: matrix.platform != 'windows-latest'
        run: ./build-frontend.sh

      - name: Build frontend (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: ./build-frontend.ps1

      - name: Build Tauri app
        working-directory: src-tauri
        run: cargo tauri build

      - name: Debug bundle output
        shell: bash
        run: |
          echo "=== ls target/release/bundle ==="
          ls -R target/release/bundle 2>/dev/null || echo "target/release/bundle not found"
          echo ""
          echo "=== ls src-tauri/target/release/bundle ==="
          ls -R src-tauri/target/release/bundle 2>/dev/null || echo "src-tauri/target/release/bundle not found"

      - name: Package macOS .app as zip
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          set -euxo pipefail
          # Search both possible locations
          for root in target/release/bundle src-tauri/target/release/bundle; do
            if [[ -d "$root" ]]; then
              APP_DIR=$(find "$root" -type d -name "*.app" -maxdepth 5 | head -n 1 || true)
              if [[ -n "$APP_DIR" ]]; then
                echo "Found .app at: $APP_DIR"
                ditto -c -k --sequesterRsrc --keepParent "$APP_DIR" "${APP_DIR}.zip"
                echo "Created zip: ${APP_DIR}.zip"
                break
              fi
            fi
          done

      - name: Find bundle artifacts
        id: find-artifacts
        shell: bash
        run: |
          set -euxo pipefail
          
          # Search both possible target locations
          ROOTS=("target/release/bundle" "src-tauri/target/release/bundle")
          
          collect() {
            local pattern="$1"
            local found=""
            for r in "${ROOTS[@]}"; do
              if [[ -d "$r" ]]; then
                found_files=$(find "$r" -type f $pattern 2>/dev/null || true)
                if [[ -n "$found_files" ]]; then
                  found="${found}${found_files}"$'\n'
                fi
              fi
            done
            echo "$found" | grep -v '^$' || true
          }
          
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            ARTIFACTS=$(collect "\( -name \"*.dmg\" -o -name \"*.app.zip\" \)")
          elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            ARTIFACTS=$(collect "\( -name \"*.exe\" -o -name \"*.msi\" \)")
          else
            ARTIFACTS=$(collect "\( -name \"*.deb\" -o -name \"*.rpm\" -o -name \"*.AppImage\" -o -name \"*.tar.gz\" \)")
          fi
          
          # Convert to space-separated list for softprops
          ARTIFACTS_ONE_LINE=$(echo "$ARTIFACTS" | tr '\n' ' ' | sed 's/  */ /g' | xargs || true)
          
          echo "artifacts=$ARTIFACTS_ONE_LINE" >> "$GITHUB_OUTPUT"
          echo "Found artifacts: $ARTIFACTS_ONE_LINE"

      - name: Upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: false
          prerelease: true
          generate_release_notes: true
          files: ${{ steps.find-artifacts.outputs.artifacts }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
